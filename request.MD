# ğŸš€ API Testing Guide - Helpdeskly Multitenant

## ğŸ“‹ **Table des MatiÃ¨res**

1. [Variables d'Environnement](#variables-denvironnement)
2. [Control API - Gestion des Tenants](#control-api---gestion-des-tenants)
3. [App API - Gestion des Tickets](#app-api---gestion-des-tickets)
4. [Tests de Validation](#tests-de-validation)
5. [ScÃ©narios Complets](#scÃ©narios-complets)

---

## ğŸ”§ **Variables d'Environnement**

```bash
# URLs des APIs
export CONTROL_API_URL="http://localhost:6500"
export APP_API_URL="http://localhost:3000"

# IDs de test (Ã  remplacer par les vrais IDs)
export TENANT_ID="cm..."
export USER_ID_1="cm..."
export USER_ID_2="cm..."
export TICKET_ID="cm..."
```

---

## ğŸ¢ **Control API - Gestion des Tenants**

### **1. CrÃ©er un Tenant**

```bash
# âœ… CrÃ©ation rÃ©ussie
curl -X POST $CONTROL_API_URL/tenants \
  -H "Content-Type: application/json" \
  -d '{
    "tenantName": "Acme Corporation",
    "slug": "acme-corp",
    "trialDays": 30
  }'

# âœ… CrÃ©ation avec donnÃ©es minimales
curl -X POST $CONTROL_API_URL/tenants \
  -H "Content-Type: application/json" \
  -d '{
    "tenantName": "Tech Startup",
    "slug": "tech-startup"
  }'

# âŒ Test erreur - Slug dÃ©jÃ  existant
curl -X POST $CONTROL_API_URL/tenants \
  -H "Content-Type: application/json" \
  -d '{
    "tenantName": "Duplicate Corp",
    "slug": "acme-corp"
  }'

# âŒ Test erreur - Slug invalide
curl -X POST $CONTROL_API_URL/tenants \
  -H "Content-Type: application/json" \
  -d '{
    "tenantName": "Invalid Corp",
    "slug": "INVALID_SLUG"
  }'

# âŒ Test erreur - Slug rÃ©servÃ©
curl -X POST $CONTROL_API_URL/tenants \
  -H "Content-Type: application/json" \
  -d '{
    "tenantName": "Admin Panel",
    "slug": "admin"
  }'
```

### **2. Lister les Tenants**

```bash
# âœ… Tous les tenants
curl -X GET $CONTROL_API_URL/tenants

# âœ… Tenant spÃ©cifique par ID
curl -X GET $CONTROL_API_URL/tenants/$TENANT_ID

# âœ… Tenant par slug (si endpoint existe)
curl -X GET $CONTROL_API_URL/tenants/slug/acme-corp
```

### **3. Mise Ã  Jour des Tenants**

```bash
# âœ… Mettre Ã  jour le statut
curl -X PATCH $CONTROL_API_URL/tenants/$TENANT_ID/status \
  -H "Content-Type: application/json" \
  -d '{
    "status": "ACTIVE"
  }'

# âœ… Suspendre un tenant
curl -X PATCH $CONTROL_API_URL/tenants/$TENANT_ID/status \
  -H "Content-Type: application/json" \
  -d '{
    "status": "SUSPENDED"
  }'
```

---

## ğŸ« **App API - Gestion des Tickets**

### **Headers Requis pour App API**

```bash
# Headers pour identifier le tenant (selon votre implÃ©mentation)
export TENANT_HEADERS="-H 'X-Tenant-Slug: acme-corp' -H 'Content-Type: application/json'"
# OU
export TENANT_HEADERS="-H 'Host: acme-corp.localhost:3000' -H 'Content-Type: application/json'"
```

### **1. CrÃ©er des Tickets**

```bash
# âœ… Ticket simple
curl -X POST $APP_API_URL/tickets \
  $TENANT_HEADERS \
  -d '{
    "title": "Impossible de se connecter",
    "description": "Je n'\''arrive pas Ã  me connecter Ã  mon compte depuis ce matin. Le message d'\''erreur indique que mon mot de passe est incorrect.",
    "authorId": "'$USER_ID_1'",
    "priority": "HIGH"
  }'

# âœ… Ticket avec assignation
curl -X POST $APP_API_URL/tickets \
  $TENANT_HEADERS \
  -d '{
    "title": "Demande de nouvelle fonctionnalitÃ©",
    "description": "Serait-il possible d'\''ajouter un systÃ¨me de notifications par email ?",
    "authorId": "'$USER_ID_1'",
    "assignedToId": "'$USER_ID_2'",
    "priority": "MEDIUM",
    "status": "OPEN"
  }'

# âœ… Ticket urgent
curl -X POST $APP_API_URL/tickets \
  $TENANT_HEADERS \
  -d '{
    "title": "ğŸš¨ Serveur down - Production",
    "description": "Le serveur de production ne rÃ©pond plus depuis 10 minutes. Les clients ne peuvent plus accÃ©der au service.",
    "authorId": "'$USER_ID_2'",
    "priority": "URGENT",
    "status": "OPEN"
  }'

# âŒ Test erreur - Utilisateur inexistant
curl -X POST $APP_API_URL/tickets \
  $TENANT_HEADERS \
  -d '{
    "title": "Test avec utilisateur invalide",
    "description": "Ce ticket devrait Ã©chouer",
    "authorId": "user_inexistant_123",
    "priority": "LOW"
  }'

# âŒ Test erreur - DonnÃ©es manquantes
curl -X POST $APP_API_URL/tickets \
  $TENANT_HEADERS \
  -d '{
    "description": "Titre manquant",
    "authorId": "'$USER_ID_1'"
  }'
```

### **2. Consulter les Tickets**

```bash
# âœ… Tous les tickets du tenant
curl -X GET $APP_API_URL/tickets \
  $TENANT_HEADERS

# âœ… Ticket spÃ©cifique
curl -X GET $APP_API_URL/tickets/$TICKET_ID \
  $TENANT_HEADERS

# âŒ Test erreur - Ticket inexistant
curl -X GET $APP_API_URL/tickets/ticket_inexistant_123 \
  $TENANT_HEADERS
```

### **3. Modifier des Tickets**

```bash
# âœ… Changer le statut
curl -X PUT $APP_API_URL/tickets/$TICKET_ID \
  $TENANT_HEADERS \
  -d '{
    "status": "IN_PROGRESS"
  }'

# âœ… Assigner le ticket
curl -X PUT $APP_API_URL/tickets/$TICKET_ID \
  $TENANT_HEADERS \
  -d '{
    "assignedToId": "'$USER_ID_2'",
    "status": "IN_PROGRESS"
  }'

# âœ… Changer la prioritÃ©
curl -X PUT $APP_API_URL/tickets/$TICKET_ID \
  $TENANT_HEADERS \
  -d '{
    "priority": "HIGH",
    "title": "ğŸ”¥ Urgent - Impossible de se connecter"
  }'

# âœ… RÃ©soudre le ticket
curl -X PUT $APP_API_URL/tickets/$TICKET_ID \
  $TENANT_HEADERS \
  -d '{
    "status": "RESOLVED",
    "description": "ProblÃ¨me rÃ©solu aprÃ¨s rÃ©initialisation du mot de passe."
  }'
```

### **4. Supprimer des Tickets**

```bash
# âœ… Supprimer un ticket
curl -X DELETE $APP_API_URL/tickets/$TICKET_ID \
  $TENANT_HEADERS

# âŒ Test erreur - Ticket dÃ©jÃ  supprimÃ©
curl -X DELETE $APP_API_URL/tickets/$TICKET_ID \
  $TENANT_HEADERS
```

---

## ğŸ’¬ **Gestion des Commentaires** (Si implÃ©mentÃ©)

### **1. Ajouter des Commentaires**

```bash
# âœ… Commentaire simple
curl -X POST $APP_API_URL/tickets/$TICKET_ID/comments \
  $TENANT_HEADERS \
  -d '{
    "body": "J'\''ai essayÃ© de redÃ©marrer mon ordinateur mais le problÃ¨me persiste.",
    "authorId": "'$USER_ID_1'"
  }'

# âœ… Commentaire de support
curl -X POST $APP_API_URL/tickets/$TICKET_ID/comments \
  $TENANT_HEADERS \
  -d '{
    "body": "Pouvez-vous me confirmer votre adresse email et la derniÃ¨re fois que vous avez pu vous connecter ?",
    "authorId": "'$USER_ID_2'"
  }'

# âœ… Commentaire de rÃ©solution
curl -X POST $APP_API_URL/tickets/$TICKET_ID/comments \
  $TENANT_HEADERS \
  -d '{
    "body": "âœ… ProblÃ¨me rÃ©solu ! J'\''ai rÃ©initialisÃ© votre mot de passe. Vous devriez recevoir un email avec les instructions.",
    "authorId": "'$USER_ID_2'"
  }'
```

### **2. Consulter les Commentaires**

```bash
# âœ… Tous les commentaires d'un ticket
curl -X GET $APP_API_URL/tickets/$TICKET_ID/comments \
  $TENANT_HEADERS

# âœ… Commentaire spÃ©cifique
curl -X GET $APP_API_URL/comments/$COMMENT_ID \
  $TENANT_HEADERS
```

---

## ğŸ§ª **Tests de Validation**

### **1. Tests de SÃ©curitÃ© Multi-Tenant**

```bash
# âŒ Essayer d'accÃ©der aux tickets d'un autre tenant
curl -X GET $APP_API_URL/tickets \
  -H 'X-Tenant-Slug: autre-tenant' \
  -H 'Content-Type: application/json'

# âŒ CrÃ©er un ticket avec un utilisateur d'un autre tenant
curl -X POST $APP_API_URL/tickets \
  $TENANT_HEADERS \
  -d '{
    "title": "Test sÃ©curitÃ©",
    "description": "Tentative avec utilisateur externe",
    "authorId": "utilisateur_autre_tenant",
    "priority": "LOW"
  }'
```

### **2. Tests de Performance**

```bash
# ğŸ“Š CrÃ©er plusieurs tickets rapidement
for i in {1..10}; do
  curl -X POST $APP_API_URL/tickets \
    $TENANT_HEADERS \
    -d "{
      \"title\": \"Ticket de test $i\",
      \"description\": \"Description du ticket numÃ©ro $i pour tester les performances\",
      \"authorId\": \"$USER_ID_1\",
      \"priority\": \"LOW\"
    }" &
done
wait

# ğŸ“Š RÃ©cupÃ©rer tous les tickets
time curl -X GET $APP_API_URL/tickets $TENANT_HEADERS
```

### **3. Tests de Robustesse**

```bash
# âŒ DonnÃ©es invalides
curl -X POST $APP_API_URL/tickets \
  $TENANT_HEADERS \
  -d '{
    "title": "",
    "description": null,
    "authorId": 123,
    "priority": "INVALID"
  }'

# âŒ JSON malformÃ©
curl -X POST $APP_API_URL/tickets \
  $TENANT_HEADERS \
  -d '{"title": "Test malformÃ©", "description":'

# âŒ Headers manquants
curl -X POST $APP_API_URL/tickets \
  -H 'Content-Type: application/json' \
  -d '{
    "title": "Test sans tenant",
    "description": "Ce ticket devrait Ã©chouer",
    "authorId": "'$USER_ID_1'"
  }'
```

---

## ğŸ¬ **ScÃ©narios Complets**

### **ScÃ©nario 1 : Cycle de Vie Complet d'un Tenant**

```bash
#!/bin/bash
echo "ğŸš€ CrÃ©ation d'un nouveau tenant..."

# 1. CrÃ©er le tenant
TENANT_RESPONSE=$(curl -s -X POST $CONTROL_API_URL/tenants \
  -H "Content-Type: application/json" \
  -d '{
    "tenantName": "Demo Company",
    "slug": "demo-company"
  }')

echo "Tenant crÃ©Ã©: $TENANT_RESPONSE"

# 2. Attendre le provisioning (30 secondes)
echo "â³ Attente du provisioning..."
sleep 30

# 3. VÃ©rifier le statut
echo "ğŸ” VÃ©rification du statut..."
curl -s -X GET $CONTROL_API_URL/tenants \
  | jq '.[] | select(.slug == "demo-company")'
```

### **ScÃ©nario 2 : Workflow Support Client**

```bash
#!/bin/bash
export TENANT_HEADERS="-H 'X-Tenant-Slug: demo-company' -H 'Content-Type: application/json'"

echo "ğŸ« Simulation d'un workflow support..."

# 1. Client crÃ©e un ticket
echo "1ï¸âƒ£ Client signale un problÃ¨me..."
TICKET_RESPONSE=$(curl -s -X POST $APP_API_URL/tickets \
  $TENANT_HEADERS \
  -d '{
    "title": "ProblÃ¨me de synchronisation",
    "description": "Mes donnÃ©es ne se synchronisent plus depuis hier.",
    "authorId": "'$USER_ID_1'",
    "priority": "MEDIUM"
  }')

TICKET_ID=$(echo $TICKET_RESPONSE | jq -r '.id')
echo "Ticket crÃ©Ã©: $TICKET_ID"

# 2. Support prend en charge
echo "2ï¸âƒ£ Support prend en charge..."
curl -s -X PUT $APP_API_URL/tickets/$TICKET_ID \
  $TENANT_HEADERS \
  -d '{
    "assignedToId": "'$USER_ID_2'",
    "status": "IN_PROGRESS"
  }' | jq '.'

# 3. Ajout d'un commentaire
echo "3ï¸âƒ£ Demande d'informations..."
curl -s -X POST $APP_API_URL/tickets/$TICKET_ID/comments \
  $TENANT_HEADERS \
  -d '{
    "body": "Pouvez-vous me dire quel navigateur vous utilisez ?",
    "authorId": "'$USER_ID_2'"
  }' | jq '.'

# 4. RÃ©ponse du client
echo "4ï¸âƒ£ RÃ©ponse du client..."
curl -s -X POST $APP_API_URL/tickets/$TICKET_ID/comments \
  $TENANT_HEADERS \
  -d '{
    "body": "J'\''utilise Chrome version 118.",
    "authorId": "'$USER_ID_1'"
  }' | jq '.'

# 5. RÃ©solution
echo "5ï¸âƒ£ RÃ©solution du problÃ¨me..."
curl -s -X PUT $APP_API_URL/tickets/$TICKET_ID \
  $TENANT_HEADERS \
  -d '{
    "status": "RESOLVED"
  }' | jq '.'

curl -s -X POST $APP_API_URL/tickets/$TICKET_ID/comments \
  $TENANT_HEADERS \
  -d '{
    "body": "âœ… ProblÃ¨me rÃ©solu ! Il y avait un conflit avec une extension Chrome.",
    "authorId": "'$USER_ID_2'"
  }' | jq '.'

echo "âœ… Workflow terminÃ© !"
```

### **ScÃ©nario 3 : Tests de Charge**

```bash
#!/bin/bash
echo "ğŸ“Š Tests de charge sur l'API..."

# CrÃ©er 50 tickets en parallÃ¨le
echo "CrÃ©ation de 50 tickets..."
for i in {1..50}; do
  curl -s -X POST $APP_API_URL/tickets \
    $TENANT_HEADERS \
    -d "{
      \"title\": \"Ticket automatique $i\",
      \"description\": \"Ticket gÃ©nÃ©rÃ© automatiquement pour test de charge - $i\",
      \"authorId\": \"$USER_ID_1\",
      \"priority\": \"LOW\"
    }" > /dev/null &
done

wait
echo "âœ… 50 tickets crÃ©Ã©s !"

# Tester la rÃ©cupÃ©ration
echo "Test de rÃ©cupÃ©ration de tous les tickets..."
time curl -s -X GET $APP_API_URL/tickets $TENANT_HEADERS | jq 'length'
```

---

## ğŸ“ **Notes d'Utilisation**

### **Configuration rapide :**

1. Remplacez les variables `$USER_ID_1`, `$USER_ID_2` par de vrais IDs d'utilisateurs
2. Ajustez les headers selon votre implÃ©mentation du routing multi-tenant
3. VÃ©rifiez que les deux APIs sont dÃ©marrÃ©es

### **Commandes utiles :**

```bash
# Formater les rÃ©ponses JSON
curl ... | jq '.'

# Sauvegarder les rÃ©ponses
curl ... > response.json

# Mesurer le temps de rÃ©ponse
time curl ...

# Tests en parallÃ¨le
curl ... &
```

### **Debugging :**

```bash
# Verbose pour voir les headers
curl -v ...

# Sauvegarder les headers de rÃ©ponse
curl -D headers.txt ...

# Suivre les redirections
curl -L ...
```

---

ğŸ¯ **Ce fichier couvre tous les aspects de test de votre API multitenant !**
