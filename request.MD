# üöÄ API Testing Guide - Helpdeskly Multitenant

## üìã **Table des Mati√®res**

1. [Variables d'Environnement](#variables-denvironnement)
2. [Control API - Gestion des Tenants](#control-api---gestion-des-tenants)
3. [App API - Gestion des Tickets](#app-api---gestion-des-tickets)
4. [Tests de Validation](#tests-de-validation)
5. [Sc√©narios Complets](#sc√©narios-complets)

---

## üîß **Variables d'Environnement**

```bash
# URLs des APIs
export CONTROL_API_URL="http://localhost:6500"
export APP_API_URL="http://localhost:3000"

# IDs de test (√† remplacer par les vrais IDs)
export TENANT_ID="cm..."
export USER_ID_1="cm..."
export USER_ID_2="cm..."
export TICKET_ID="cm..."
```

---

## üè¢ **Control API - Gestion des Tenants**

### **1. Cr√©er un Tenant**

```bash
# ‚úÖ Cr√©ation r√©ussie
curl -X POST $CONTROL_API_URL/tenants \
  -H "Content-Type: application/json" \
  -d '{
    "tenantName": "Acme Corporation",
    "slug": "acme-corp",
    "trialDays": 30
  }'

# ‚úÖ Cr√©ation avec donn√©es minimales
curl -X POST $CONTROL_API_URL/tenants \
  -H "Content-Type: application/json" \
  -d '{
    "tenantName": "Tech Startup",
    "slug": "tech-startup"
  }'

# ‚ùå Test erreur - Slug d√©j√† existant
curl -X POST $CONTROL_API_URL/tenants \
  -H "Content-Type: application/json" \
  -d '{
    "tenantName": "Duplicate Corp",
    "slug": "acme-corp"
  }'

# ‚ùå Test erreur - Slug invalide
curl -X POST $CONTROL_API_URL/tenants \
  -H "Content-Type: application/json" \
  -d '{
    "tenantName": "Invalid Corp",
    "slug": "INVALID_SLUG"
  }'

# ‚ùå Test erreur - Slug r√©serv√©
curl -X POST $CONTROL_API_URL/tenants \
  -H "Content-Type: application/json" \
  -d '{
    "tenantName": "Admin Panel",
    "slug": "admin"
  }'
```

### **2. Lister les Tenants**

```bash
# ‚úÖ Tous les tenants
curl -X GET $CONTROL_API_URL/tenants

# ‚úÖ Tenant sp√©cifique par ID
curl -X GET $CONTROL_API_URL/tenants/$TENANT_ID

# ‚úÖ Tenant par slug (si endpoint existe)
curl -X GET $CONTROL_API_URL/tenants/slug/acme-corp
```

### **3. Mise √† Jour des Tenants**

```bash
# ‚úÖ Mettre √† jour le statut
curl -X PATCH $CONTROL_API_URL/tenants/$TENANT_ID/status \
  -H "Content-Type: application/json" \
  -d '{
    "status": "ACTIVE"
  }'

# ‚úÖ Suspendre un tenant
curl -X PATCH $CONTROL_API_URL/tenants/$TENANT_ID/status \
  -H "Content-Type: application/json" \
  -d '{
    "status": "SUSPENDED"
  }'
```

---

## üé´ **App API - Gestion des Tickets**

### **Headers Requis pour App API**

```bash
# Headers pour identifier le tenant (selon votre impl√©mentation)
export TENANT_HEADERS="-H 'X-Tenant-Slug: acme-corp' -H 'Content-Type: application/json'"
# OU
export TENANT_HEADERS="-H 'Host: acme-corp.localhost:3000' -H 'Content-Type: application/json'"
```

### **1. Cr√©er des Tickets**

```bash
# ‚úÖ Ticket simple
curl -X POST $APP_API_URL/tickets \
  $TENANT_HEADERS \
  -d '{
    "title": "Impossible de se connecter",
    "description": "Je n'\''arrive pas √† me connecter √† mon compte depuis ce matin. Le message d'\''erreur indique que mon mot de passe est incorrect.",
    "authorId": "'$USER_ID_1'",
    "priority": "HIGH"
  }'

# ‚úÖ Ticket avec assignation
curl -X POST $APP_API_URL/tickets \
  $TENANT_HEADERS \
  -d '{
    "title": "Demande de nouvelle fonctionnalit√©",
    "description": "Serait-il possible d'\''ajouter un syst√®me de notifications par email ?",
    "authorId": "'$USER_ID_1'",
    "assignedToId": "'$USER_ID_2'",
    "priority": "MEDIUM",
    "status": "OPEN"
  }'

# ‚úÖ Ticket urgent
curl -X POST $APP_API_URL/tickets \
  $TENANT_HEADERS \
  -d '{
    "title": "üö® Serveur down - Production",
    "description": "Le serveur de production ne r√©pond plus depuis 10 minutes. Les clients ne peuvent plus acc√©der au service.",
    "authorId": "'$USER_ID_2'",
    "priority": "URGENT",
    "status": "OPEN"
  }'

# ‚ùå Test erreur - Utilisateur inexistant
curl -X POST $APP_API_URL/tickets \
  $TENANT_HEADERS \
  -d '{
    "title": "Test avec utilisateur invalide",
    "description": "Ce ticket devrait √©chouer",
    "authorId": "user_inexistant_123",
    "priority": "LOW"
  }'

# ‚ùå Test erreur - Donn√©es manquantes
curl -X POST $APP_API_URL/tickets \
  $TENANT_HEADERS \
  -d '{
    "description": "Titre manquant",
    "authorId": "'$USER_ID_1'"
  }'
```

### **2. Consulter les Tickets**

```bash
# ‚úÖ Tous les tickets du tenant
curl -X GET $APP_API_URL/tickets \
  $TENANT_HEADERS

# ‚úÖ Ticket sp√©cifique
curl -X GET $APP_API_URL/tickets/$TICKET_ID \
  $TENANT_HEADERS

# ‚ùå Test erreur - Ticket inexistant
curl -X GET $APP_API_URL/tickets/ticket_inexistant_123 \
  $TENANT_HEADERS
```

### **3. Modifier des Tickets**

```bash
# ‚úÖ Changer le statut
curl -X PUT $APP_API_URL/tickets/$TICKET_ID \
  $TENANT_HEADERS \
  -d '{
    "status": "IN_PROGRESS"
  }'

# ‚úÖ Assigner le ticket
curl -X PUT $APP_API_URL/tickets/$TICKET_ID \
  $TENANT_HEADERS \
  -d '{
    "assignedToId": "'$USER_ID_2'",
    "status": "IN_PROGRESS"
  }'

# ‚úÖ Changer la priorit√©
curl -X PUT $APP_API_URL/tickets/$TICKET_ID \
  $TENANT_HEADERS \
  -d '{
    "priority": "HIGH",
    "title": "üî• Urgent - Impossible de se connecter"
  }'

# ‚úÖ R√©soudre le ticket
curl -X PUT $APP_API_URL/tickets/$TICKET_ID \
  $TENANT_HEADERS \
  -d '{
    "status": "RESOLVED",
    "description": "Probl√®me r√©solu apr√®s r√©initialisation du mot de passe."
  }'
```

### **4. Supprimer des Tickets**

```bash
# ‚úÖ Supprimer un ticket
curl -X DELETE $APP_API_URL/tickets/$TICKET_ID \
  $TENANT_HEADERS

# ‚ùå Test erreur - Ticket d√©j√† supprim√©
curl -X DELETE $APP_API_URL/tickets/$TICKET_ID \
  $TENANT_HEADERS
```

---

## üí¨ **Gestion des Commentaires** (Si impl√©ment√©)

### **1. Ajouter des Commentaires**

```bash
# ‚úÖ Commentaire simple
curl -X POST $APP_API_URL/tickets/$TICKET_ID/comments \
  $TENANT_HEADERS \
  -d '{
    "body": "J'\''ai essay√© de red√©marrer mon ordinateur mais le probl√®me persiste.",
    "authorId": "'$USER_ID_1'"
  }'

# ‚úÖ Commentaire de support
curl -X POST $APP_API_URL/tickets/$TICKET_ID/comments \
  $TENANT_HEADERS \
  -d '{
    "body": "Pouvez-vous me confirmer votre adresse email et la derni√®re fois que vous avez pu vous connecter ?",
    "authorId": "'$USER_ID_2'"
  }'

# ‚úÖ Commentaire de r√©solution
curl -X POST $APP_API_URL/tickets/$TICKET_ID/comments \
  $TENANT_HEADERS \
  -d '{
    "body": "‚úÖ Probl√®me r√©solu ! J'\''ai r√©initialis√© votre mot de passe. Vous devriez recevoir un email avec les instructions.",
    "authorId": "'$USER_ID_2'"
  }'
```

### **2. Consulter les Commentaires**

```bash
# ‚úÖ Tous les commentaires d'un ticket
curl -X GET $APP_API_URL/tickets/$TICKET_ID/comments \
  $TENANT_HEADERS

# ‚úÖ Commentaire sp√©cifique
curl -X GET $APP_API_URL/comments/$COMMENT_ID \
  $TENANT_HEADERS
```

---

## üß™ **Tests de Validation**

### **1. Tests de S√©curit√© Multi-Tenant**

```bash
# ‚ùå Essayer d'acc√©der aux tickets d'un autre tenant
curl -X GET $APP_API_URL/tickets \
  -H 'X-Tenant-Slug: autre-tenant' \
  -H 'Content-Type: application/json'

# ‚ùå Cr√©er un ticket avec un utilisateur d'un autre tenant
curl -X POST $APP_API_URL/tickets \
  $TENANT_HEADERS \
  -d '{
    "title": "Test s√©curit√©",
    "description": "Tentative avec utilisateur externe",
    "authorId": "utilisateur_autre_tenant",
    "priority": "LOW"
  }'
```

### **2. Tests de Performance**

```bash
# üìä Cr√©er plusieurs tickets rapidement
for i in {1..10}; do
  curl -X POST $APP_API_URL/tickets \
    $TENANT_HEADERS \
    -d "{
      \"title\": \"Ticket de test $i\",
      \"description\": \"Description du ticket num√©ro $i pour tester les performances\",
      \"authorId\": \"$USER_ID_1\",
      \"priority\": \"LOW\"
    }" &
done
wait

# üìä R√©cup√©rer tous les tickets
time curl -X GET $APP_API_URL/tickets $TENANT_HEADERS
```

### **3. Tests de Robustesse**

```bash
# ‚ùå Donn√©es invalides
curl -X POST $APP_API_URL/tickets \
  $TENANT_HEADERS \
  -d '{
    "title": "",
    "description": null,
    "authorId": 123,
    "priority": "INVALID"
  }'

# ‚ùå JSON malform√©
curl -X POST $APP_API_URL/tickets \
  $TENANT_HEADERS \
  -d '{"title": "Test malform√©", "description":'

# ‚ùå Headers manquants
curl -X POST $APP_API_URL/tickets \
  -H 'Content-Type: application/json' \
  -d '{
    "title": "Test sans tenant",
    "description": "Ce ticket devrait √©chouer",
    "authorId": "'$USER_ID_1'"
  }'
```

---

## üé¨ **Sc√©narios Complets**

### **Sc√©nario 1 : Cycle de Vie Complet d'un Tenant**

```bash
#!/bin/bash
echo "üöÄ Cr√©ation d'un nouveau tenant..."

# 1. Cr√©er le tenant
TENANT_RESPONSE=$(curl -s -X POST $CONTROL_API_URL/tenants \
  -H "Content-Type: application/json" \
  -d '{
    "tenantName": "Demo Company",
    "slug": "demo-company"
  }')

echo "Tenant cr√©√©: $TENANT_RESPONSE"

# 2. Attendre le provisioning (30 secondes)
echo "‚è≥ Attente du provisioning..."
sleep 30

# 3. V√©rifier le statut
echo "üîç V√©rification du statut..."
curl -s -X GET $CONTROL_API_URL/tenants \
  | jq '.[] | select(.slug == "demo-company")'
```

### **Sc√©nario 2 : Workflow Support Client**

```bash
#!/bin/bash
export TENANT_HEADERS="-H 'X-Tenant-Slug: demo-company' -H 'Content-Type: application/json'"

echo "üé´ Simulation d'un workflow support..."

# 1. Client cr√©e un ticket
echo "1Ô∏è‚É£ Client signale un probl√®me..."
TICKET_RESPONSE=$(curl -s -X POST $APP_API_URL/tickets \
  $TENANT_HEADERS \
  -d '{
    "title": "Probl√®me de synchronisation",
    "description": "Mes donn√©es ne se synchronisent plus depuis hier.",
    "authorId": "'$USER_ID_1'",
    "priority": "MEDIUM"
  }')

TICKET_ID=$(echo $TICKET_RESPONSE | jq -r '.id')
echo "Ticket cr√©√©: $TICKET_ID"

# 2. Support prend en charge
echo "2Ô∏è‚É£ Support prend en charge..."
curl -s -X PUT $APP_API_URL/tickets/$TICKET_ID \
  $TENANT_HEADERS \
  -d '{
    "assignedToId": "'$USER_ID_2'",
    "status": "IN_PROGRESS"
  }' | jq '.'

# 3. Ajout d'un commentaire
echo "3Ô∏è‚É£ Demande d'informations..."
curl -s -X POST $APP_API_URL/tickets/$TICKET_ID/comments \
  $TENANT_HEADERS \
  -d '{
    "body": "Pouvez-vous me dire quel navigateur vous utilisez ?",
    "authorId": "'$USER_ID_2'"
  }' | jq '.'

# 4. R√©ponse du client
echo "4Ô∏è‚É£ R√©ponse du client..."
curl -s -X POST $APP_API_URL/tickets/$TICKET_ID/comments \
  $TENANT_HEADERS \
  -d '{
    "body": "J'\''utilise Chrome version 118.",
    "authorId": "'$USER_ID_1'"
  }' | jq '.'

# 5. R√©solution
echo "5Ô∏è‚É£ R√©solution du probl√®me..."
curl -s -X PUT $APP_API_URL/tickets/$TICKET_ID \
  $TENANT_HEADERS \
  -d '{
    "status": "RESOLVED"
  }' | jq '.'

curl -s -X POST $APP_API_URL/tickets/$TICKET_ID/comments \
  $TENANT_HEADERS \
  -d '{
    "body": "‚úÖ Probl√®me r√©solu ! Il y avait un conflit avec une extension Chrome.",
    "authorId": "'$USER_ID_2'"
  }' | jq '.'

echo "‚úÖ Workflow termin√© !"
```

### **Sc√©nario 3 : Tests de Charge**

```bash
#!/bin/bash
echo "üìä Tests de charge sur l'API..."

# Cr√©er 50 tickets en parall√®le
echo "Cr√©ation de 50 tickets..."
for i in {1..50}; do
  curl -s -X POST $APP_API_URL/tickets \
    $TENANT_HEADERS \
    -d "{
      \"title\": \"Ticket automatique $i\",
      \"description\": \"Ticket g√©n√©r√© automatiquement pour test de charge - $i\",
      \"authorId\": \"$USER_ID_1\",
      \"priority\": \"LOW\"
    }" > /dev/null &
done

wait
echo "‚úÖ 50 tickets cr√©√©s !"

# Tester la r√©cup√©ration
echo "Test de r√©cup√©ration de tous les tickets..."
time curl -s -X GET $APP_API_URL/tickets $TENANT_HEADERS | jq 'length'
```

---

## üìù **Notes d'Utilisation**

### **Configuration rapide :**

1. Remplacez les variables `$USER_ID_1`, `$USER_ID_2` par de vrais IDs d'utilisateurs
2. Ajustez les headers selon votre impl√©mentation du routing multi-tenant
3. V√©rifiez que les deux APIs sont d√©marr√©es

### **Commandes utiles :**

```bash
# Formater les r√©ponses JSON
curl ... | jq '.'

# Sauvegarder les r√©ponses
curl ... > response.json

# Mesurer le temps de r√©ponse
time curl ...

# Tests en parall√®le
curl ... &
```

### **Debugging :**

```bash
# Verbose pour voir les headers
curl -v ...

# Sauvegarder les headers de r√©ponse
curl -D headers.txt ...

# Suivre les redirections
curl -L ...
```

---

üéØ **Ce fichier couvre tous les aspects de test de votre API multitenant !**
